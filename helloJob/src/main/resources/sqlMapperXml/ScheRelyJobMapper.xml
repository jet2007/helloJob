<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.helloJob.mapper.job.ScheRelyJobMapper">

  <select id="getReferJobIdsOfOneJob" resultType="Long" >
	select pid from sche_rely_job where job_id = #{jobId}
	union 
	select job_id from sche_rely_job where pid = #{jobId}
    </select> 
  <select id="getTreeList" resultType="com.helloJob.commons.result.Tree" parameterType="java.util.Set">
	SELECT t1.`id`,t2.pid,CONCAT(t1.job_name,'(',t1.id,')') `text` FROM job_basic_info t1 LEFT JOIN sche_rely_job t2 ON t1.id = t2.job_id
WHERE t1.id IN
  <foreach collection="referJobIds" index="index" item="jobId" open="(" separator="," close=")">  
            #{jobId}  
        </foreach>
   </select> 
   
   
     <select id="getTreeListJobInst" resultType="com.helloJob.commons.result.Tree" parameterType="java.util.Set">
SELECT A1.`id`
      ,A1.pid
      ,CONCAT(A1.job_name,'(id=',A1.id,',dt=',#{dt} ,')'  ) `text` 
      ,IF(A2.job_id IS NOT NULL ,
        CONCAT(A1.job_name,'(id=',A1.id,',dt=',#{jobId} ,'总计[',A2.total,
              IF(A2.total_succ>0,CONCAT(',成功[',A2.total_succ,']'),''),
              IF(A2.total_running>0,CONCAT(',执行中[',A2.total_running,']'),''),
              IF(A2.total_fail>0,CONCAT(',失败[',A2.total_fail,']'),'')
              ,')'
              ) 
        ,CONCAT(A1.job_name,'(id=',A1.id,',dt=',#{dt} ,'未执行')
        ) AS `text` 
      
  FROM (
    SELECT t1.`id`,t2.pid,t1.job_name
      FROM job_basic_info t1 
 LEFT JOIN sche_rely_job t2 
        ON t1.id = t2.job_id
     WHERE t1.id IN
  <foreach collection="referJobIds" index="index" item="jobId" open="(" separator="," close=")">  
            #{jobId}  
        </foreach>
       ) A1
LEFT JOIN (
  SELECT job_id
        ,SUM(1) total
        ,SUM(CASE WHEN job_state='成功' THEN 1 ELSE 0 END ) AS  total_succ
        ,SUM(CASE WHEN job_state='执行中' THEN 1 ELSE 0 END ) AS  total_running
        ,SUM(CASE WHEN job_state='失败' THEN 1 ELSE 0 END )  AS total_fail
    FROM job_log 
   WHERE `id` IN
  <foreach collection="referJobIds" index="index" item="jobId" open="(" separator="," close=")">  
            #{jobId}  
        </foreach>  
     AND dt=#{dt} 
group BY job_id 
          ) A2
       ON A1.id=A2.job_id
   </select> 
   
     <select id="getTriggerJobs" resultType="Long" >
	select job_id from sche_rely_job where pid = #{jobId}
    </select> 
</mapper>